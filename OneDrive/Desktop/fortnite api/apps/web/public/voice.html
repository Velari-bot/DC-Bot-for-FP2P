<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/Logo.png">
    <link rel="shortcut icon" type="image/png" href="/Logo.png">
    <link rel="apple-touch-icon" href="/Logo.png">
    <title>Voice Interaction - PathGen AI</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pathgen.dev/voice">
    <meta property="og:title" content="Voice Coach - PathGen AI">
    <meta property="og:description" content="Get real-time voice coaching during your Fortnite matches.">
    <meta property="og:image" content="https://pathgen.dev/embed.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://pathgen.dev/voice">
    <meta name="twitter:title" content="Voice Coach - PathGen AI">
    <meta name="twitter:description" content="Get real-time voice coaching during your Fortnite matches.">
    <meta name="twitter:image" content="https://pathgen.dev/embed.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0A0A0A;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 100px 20px 40px;
            position: relative;
            overflow-x: hidden;
        }

        /* Purple-Blue Gradient Glow Background */
        .background-glow {
            position: fixed;
            bottom: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 1000px;
            height: 1000px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 30%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            filter: blur(60px);
        }

        /* Background Dashboard Previews */
        .dashboard-previews {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            pointer-events: none;
            overflow: hidden;
        }

        .preview-card {
            position: absolute;
            background: #151515;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 24px;
            width: 340px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.6);
            opacity: 0.4;
            transition: transform 0.3s ease;
        }

        .preview-left {
            left: 5%;
            top: 25%;
            transform: rotate(-8deg) perspective(1000px) rotateY(8deg);
        }

        .preview-center-left {
            left: 12%;
            top: 40%;
            transform: rotate(-3deg) perspective(1000px) rotateY(5deg);
            opacity: 0.25;
        }

        .preview-right {
            right: 5%;
            top: 30%;
            transform: rotate(8deg) perspective(1000px) rotateY(-8deg);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .card-icon {
            width: 32px;
            height: 32px;
            background: #2a2a2a;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .card-icon svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        .card-title {
            font-size: 0.95rem;
            color: #C5C5C5;
            font-weight: 600;
        }

        .card-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            color: #A0A0A0;
            font-size: 0.9rem;
        }

        .card-menu-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: #FFFFFF;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #FFFFFF;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }

        .avatar:has(img) {
            background: transparent !important;
        }

        .avatar-purple { background: #8B5CF6; }
        .avatar-orange { background: #F59E0B; }
        .avatar-pink { background: #EC4899; }

        .message-item {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.02);
        }

        .message-item .avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .message-name {
            font-size: 0.85rem;
            color: #FFFFFF;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .message-preview {
            font-size: 0.8rem;
            color: #666;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .navbar-container {
            backdrop-filter: blur(16px);
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 50px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 
                        0 0 0 1px rgba(255, 255, 255, 0.03),
                        inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #FFFFFF;
            text-decoration: none;
            padding: 0 8px;
            margin-right: 4px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .nav-links {
            display: flex;
            gap: 2px;
            align-items: center;
            margin: 0 8px;
        }

        .nav-link {
            color: #A0A0A0;
            text-decoration: none;
            font-size: 0.875rem;
            padding: 6px 14px;
            border-radius: 25px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 3px;
            font-weight: 500;
        }

        .nav-link:hover {
            color: #FFFFFF;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-link .caret {
            font-size: 8px;
            margin-left: 1px;
            opacity: 0.7;
        }

        .nav-link.external::after {
            content: '\2197';
            font-size: 10px;
            opacity: 0.6;
            margin-left: 2px;
        }

        .nav-center {
            display: flex;
            gap: 2px;
            align-items: center;
            margin: 0 8px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .dropdown:hover .dropdown-menu,
        .dropdown-menu:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: #E0E0E0;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }
        .dropdown-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .dropdown-item.locked:hover {
            background: transparent;
            color: #6b7280;
        }

        .dropdown-item-icon {
            font-size: 1rem;
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 12px 4px 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 25px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #3b82f6 0%, #a855f7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        .container {
            max-width: 900px;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* Voice Selection Screen */
        .voice-selection-screen {
            background: transparent;
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .voice-selection-screen.hidden {
            display: none;
        }

        .screen-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 80px;
            text-align: center;
        }

        .voice-carousel {
            position: relative;
            width: 100%;
            max-width: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 60px;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .voice-slide {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.5s ease;
        }

        .voice-slide.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .carousel-arrow:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-arrow:active {
            transform: translateY(-50%) scale(0.95);
        }

        .carousel-arrow.left {
            left: -80px;
        }

        .carousel-arrow.right {
            right: -80px;
        }

        .carousel-arrow svg {
            width: 24px;
            height: 24px;
        }

        .carousel-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .carousel-arrow:disabled:hover {
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
        }

        .voice-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin-bottom: 30px;
            position: relative;
            overflow: visible;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            padding: 2px;
            background: rgba(255, 255, 255, 0.05);
        }

        .voice-avatar::before {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 50%;
            z-index: -1;
        }

        .voice-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.6), 
                        0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .voice-avatar.selected {
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3), 
                        0 20px 60px rgba(0, 0, 0, 0.5),
                        0 0 0 5px rgba(255, 255, 255, 0.1);
        }

        .voice-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 0;
        }

        /* Liquid flow background layer */
        .voice-avatar-inner::before {
            content: '';
            position: absolute;
            inset: -100%;
            background: inherit;
            animation: liquidFlow 8s ease-in-out infinite;
            filter: blur(60px);
            opacity: 0.5;
            z-index: 0;
        }

        @keyframes liquidFlow {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg) scale(1);
            }
            25% {
                transform: translate(30px, -30px) rotate(90deg) scale(1.2);
            }
            50% {
                transform: translate(-30px, 30px) rotate(180deg) scale(0.8);
            }
            75% {
                transform: translate(30px, 30px) rotate(270deg) scale(1.1);
            }
        }

        /* Animated gradient backgrounds with liquid effect */
        .voice-avatar-inner.vale {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #a8edea 100%);
            background-size: 200% 200%;
            animation: gradientFlowVale 6s ease infinite;
        }

        @keyframes gradientFlowVale {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.alloy .voice-avatar-inner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 200%;
            animation: gradientFlowAlloy 7s ease infinite;
        }

        @keyframes gradientFlowAlloy {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.echo .voice-avatar-inner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientFlowEcho 8s ease infinite;
        }

        @keyframes gradientFlowEcho {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.fable .voice-avatar-inner {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #4facfe 100%);
            background-size: 200% 200%;
            animation: gradientFlowFable 6.5s ease infinite;
        }

        @keyframes gradientFlowFable {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.onxy .voice-avatar-inner {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 50%, #43e97b 100%);
            background-size: 200% 200%;
            animation: gradientFlowOnyx 7.5s ease infinite;
        }

        @keyframes gradientFlowOnyx {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.nova .voice-avatar-inner {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 50%, #fa709a 100%);
            background-size: 200% 200%;
            animation: gradientFlowNova 6s ease infinite;
        }

        @keyframes gradientFlowNova {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.shimmer .voice-avatar-inner {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 50%, #30cfd0 100%);
            background-size: 200% 200%;
            animation: gradientFlowShimmer 8.5s ease infinite;
        }

        @keyframes gradientFlowShimmer {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .voice-avatar.charon .voice-avatar-inner {
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 50%, #a8c0ff 100%);
            background-size: 200% 200%;
            animation: gradientFlowCharon 7s ease infinite;
        }

        @keyframes gradientFlowCharon {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Liquid shimmer overlay effect */
        .voice-avatar-inner::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 70%);
            animation: liquidShimmer 4s ease-in-out infinite;
            pointer-events: none;
            border-radius: 50%;
            z-index: 1;
        }

        @keyframes liquidShimmer {
            0%, 100% {
                opacity: 0.3;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
            25% {
                opacity: 0.5;
                transform: translate(-40%, -40%) scale(1.1) rotate(90deg);
            }
            50% {
                opacity: 0.6;
                transform: translate(-30%, -30%) scale(1.2) rotate(180deg);
            }
            75% {
                opacity: 0.4;
                transform: translate(-35%, -35%) scale(1.15) rotate(270deg);
            }
        }

        .voice-name {
            font-size: 1.75rem;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 12px;
            text-align: center;
        }

        .voice-description {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            max-width: 400px;
        }

        .pagination-dots {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 60px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.2);
        }

        .dot.active {
            background: #FFFFFF;
            width: 30px;
            border-radius: 5px;
            transform: scale(1);
        }

        .continue-button {
            margin-top: 60px;
            padding: 16px 48px;
            background: #FFFFFF;
            color: #0A0A0A;
            border: none;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .continue-button:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
        }

        .continue-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
        }

        .continue-button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Subscription Required Popup - Matching Purchase Success Style */
        .subscription-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            padding: 20px;
        }

        .subscription-popup-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .subscription-popup {
            background: #ffffff;
            border-radius: 12px;
            padding: 32px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease;
            text-align: center;
        }

        .subscription-popup.show {
            transform: scale(1);
            opacity: 1;
        }

        .popup-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 24px;
            font-weight: 300;
            transition: color 0.2s ease;
            z-index: 10;
        }

        .popup-close:hover {
            color: #000;
        }

        .popup-content {
            position: relative;
        }

        .subscription-popup-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-icon-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-icon-circle::after {
            content: '‚úì';
            color: white;
            font-size: 36px;
            font-weight: 700;
        }

        .subscription-popup-title {
            font-size: 24px;
            font-weight: 700;
            color: #000;
            text-align: center;
            margin-bottom: 8px;
        }

        .subscription-popup-message {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .subscription-popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .subscription-popup-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            flex: 1;
            min-width: 140px;
        }

        .subscription-popup-button.primary {
            background: #4f8cff;
            color: white;
        }

        .subscription-popup-button.primary:hover {
            background: #3b7ce0;
        }

        .subscription-popup-button.secondary {
            background: #f5f5f5;
            color: #000;
            border: 1px solid #e0e0e0;
        }

        .subscription-popup-button.secondary:hover {
            background: #e8e8e8;
        }

        .subscription-popup-retry {
            margin-top: 16px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }

        .subscription-popup-retry button {
            background: transparent;
            border: none;
            color: #4f8cff;
            cursor: pointer;
            text-decoration: underline;
            font-size: 13px;
            padding: 0;
        }

        .subscription-popup-retry button:hover {
            color: #3b7ce0;
        }

        @media (max-width: 640px) {
            .subscription-popup {
                padding: 24px;
            }

            .subscription-popup-buttons {
                flex-direction: column;
            }

            .subscription-popup-button {
                width: 100%;
            }
        }

        /* Voice Interaction Screen */
        .voice-interaction-screen {
            background: transparent;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            display: none;
            padding: 40px 20px;
        }

        .voice-interaction-screen.active {
            display: flex;
        }

        .interaction-header {
            width: 100%;
            text-align: center;
            margin-bottom: 40px;
        }

        .header-title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
        }

        .header-subtitle {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 28px;
            font-weight: 400;
        }

        .usage-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 24px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .usage-display.warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.15));
            border-color: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .usage-display.error {
            background: linear-gradient(135deg, rgba(245, 87, 108, 0.15), rgba(220, 38, 38, 0.15));
            border-color: rgba(245, 87, 108, 0.3);
            color: #f5576c;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Main Interaction Zone */
        .interaction-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 80px 0;
            width: 100%;
            padding: 40px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .mic-button-container {
            position: relative;
            margin-bottom: 30px;
        }

        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #FFFFFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .mic-button:hover:not(.disabled):not(.recording) {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .mic-button.recording {
            background: #f5576c;
            border-color: #f5576c;
            animation: recordingPulse 1.5s ease infinite;
        }

        .mic-button.processing {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(59, 130, 246, 0.1);
        }

        .mic-button.playing {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
        }

        .mic-button.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(100, 100, 100, 0.1);
            border-color: rgba(100, 100, 100, 0.2);
        }

        @keyframes recordingPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(245, 87, 108, 0);
            }
        }

        .mic-button svg {
            width: 48px;
            height: 48px;
        }

        .mic-ring {
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            animation: ringPulse 2s ease infinite;
        }

        @keyframes ringPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .mic-ring.recording {
            border-color: rgba(245, 87, 108, 0.5);
            animation: ringPulseRecording 1s ease infinite;
        }

        @keyframes ringPulseRecording {
            0%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.15);
                opacity: 1;
            }
        }

        .status-text {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            margin-top: 24px;
            min-height: 28px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .status-text.recording {
            color: #f5576c;
        }

        .status-text.processing {
            color: #3b82f6;
        }

        .status-text.playing {
            color: #22c55e;
        }

        /* Waveform */
        .waveform-container {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin: 40px 0;
            min-height: 80px;
        }

        .waveform-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .waveform-bar.animate {
            animation: waveformWave 0.6s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.5s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.4s; }

        @keyframes waveformWave {
            0%, 100% { height: 20px; }
            50% { height: 60px; }
        }

        /* Response Feed */
        .response-feed {
            width: 100%;
            max-width: 700px;
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .response-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .response-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .response-category {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .response-transcript {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
            font-style: italic;
        }

        .response-text {
            font-size: 1rem;
            color: #FFFFFF;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .response-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .play-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #FFFFFF;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .play-button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .play-button svg {
            width: 16px;
            height: 16px;
        }

        /* Usage Banners */
        .usage-banner {
            width: 100%;
            max-width: 700px;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .usage-banner.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .usage-banner.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .usage-banner.error {
            background: rgba(245, 87, 108, 0.1);
            border: 1px solid rgba(245, 87, 108, 0.3);
            color: #f5576c;
        }

        .usage-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .usage-banner-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .usage-banner-link {
            font-size: 0.875rem;
            color: inherit;
            text-decoration: underline;
            opacity: 0.8;
        }

        .usage-banner-link:hover {
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: #FFFFFF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .carousel-arrow.left {
                left: -60px;
            }

            .carousel-arrow.right {
                right: -60px;
            }

            .voice-avatar {
                width: 160px;
                height: 160px;
            }
        }

        @media (max-width: 968px) {
            .dashboard-previews {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .carousel-arrow {
                width: 40px;
                height: 40px;
            }

            .carousel-arrow.left {
                left: 10px;
            }

            .carousel-arrow.right {
                right: 10px;
            }

            .voice-avatar {
                width: 140px;
                height: 140px;
            }

            .screen-title {
                font-size: 2rem;
                margin-bottom: 60px;
            }

            .control-buttons {
                gap: 20px;
            }

            .control-button {
                width: 60px;
                height: 60px;
            }

            .dashboard-previews {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Background Glow -->
    <div class="background-glow"></div>

        <!-- Background AI Voice Assistant Cards -->
        <div class="dashboard-previews">
            <!-- Left Preview Card - Voice Features -->
            <div class="preview-card preview-left">
                <div class="card-header">
                    <div class="card-icon">üé§</div>
                    <div class="card-title">Voice Features</div>
                </div>
                <div class="card-menu-item active">
                    <div class="menu-icon">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                        </svg>
                    </div>
                    <span>Real-time Coaching</span>
                </div>
                <div class="card-menu-item">
                    <div class="menu-icon">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                    </div>
                    <span>Tactical Feedback</span>
                </div>
                <div class="card-menu-item">
                    <div class="menu-icon">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span>Instant Analysis</span>
                </div>
                <div class="card-menu-item">
                    <div class="menu-icon">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span>Voice History</span>
                </div>
            </div>

            <!-- Center-Left Preview (subtle) - AI Capabilities -->
            <div class="preview-card preview-center-left">
                <div class="card-header">
                    <div class="card-icon">ü§ñ</div>
                    <div class="card-title">AI Capabilities</div>
                </div>
                <div class="card-menu-item">
                    <span>Fortnite Expertise</span>
                </div>
                <div class="card-menu-item">
                    <span>Meta Analysis</span>
                </div>
                <div class="card-menu-item">
                    <span>Skill Assessment</span>
                </div>
            </div>

            <!-- Right Preview Card - Voice Stats -->
            <div class="preview-card preview-right">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Voice Stats</div>
                </div>
                <div class="message-item">
                    <div class="avatar avatar-purple">V</div>
                    <div>
                        <div class="message-name">Vale</div>
                        <div class="message-preview">Bright and inquisitive</div>
                    </div>
                </div>
                <div class="message-item">
                    <div class="avatar avatar-orange">A</div>
                    <div>
                        <div class="message-name">Alloy</div>
                        <div class="message-preview">Clear and confident</div>
                    </div>
                </div>
                <div class="message-item">
                    <div class="avatar avatar-pink">E</div>
                    <div>
                        <div class="message-name">Echo</div>
                        <div class="message-preview">Deep and resonant</div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" role="img" style="width: 24px; height: 24px;">
                        <defs>
                            <filter id="sparkleBlur">
                                <feGaussianBlur in="SourceGraphic" stdDeviation="0.8"/>
                            </filter>
                        </defs>
                        
                        <!-- P Glyph with Facets -->
                        <g id="glyph">
                            <rect x="20" y="20" width="16" height="60" rx="8" ry="8" fill="#FFFFFF"/>
                            <path d="M 36 20 H 50 A 24 24 0 0 1 50 58 H 36 V 20 Z" fill="#FFFFFF"/>
                            <path d="M 45 28 L 58 32 L 54 40 L 42 38 Z" fill="#000000" opacity="0.3"/>
                            <path d="M 44 42 L 56 46 L 48 52 Z" fill="#000000" opacity="0.25"/>
                            <path d="M 38 26 L 42 24 L 42 34 L 38 36 Z" fill="#000000" opacity="0.2"/>
                        </g>
                        
                        <!-- Cosmic Sparkles -->
                        <g id="sparkles" opacity="0.85">
                            <circle cx="64" cy="26" r="2.5" fill="#FFFFFF" filter="url(#sparkleBlur)" class="sparkle-1"/>
                            <circle cx="70" cy="38" r="1.8" fill="#FFFFFF" filter="url(#sparkleBlur)" class="sparkle-2"/>
                            <circle cx="52" cy="35" r="1.2" fill="#FFFFFF" opacity="0.8" filter="url(#sparkleBlur)" class="sparkle-3"/>
                            <circle cx="58" cy="28" r="0.9" fill="#FFFFFF" opacity="0.7" class="sparkle-4"/>
                            <circle cx="24" cy="48" r="1.5" fill="#FFFFFF" filter="url(#sparkleBlur)" class="sparkle-5"/>
                            <circle cx="60" cy="50" r="1.0" fill="#FFFFFF" opacity="0.6" class="sparkle-6"/>
                        </g>
                    </svg>
                </div>
                <span>Pathgen v2</span>
            </a>
            
            <div class="nav-center">
                <a href="/docs.html" class="nav-link">Docs</a>
                <div class="dropdown">
                    <a href="#" class="nav-link" onclick="event.preventDefault();">
                        Features
                        <span class="caret">‚ñº</span>
                    </a>
                    <div class="dropdown-menu">
                        <a href="/chat.html" class="dropdown-item">
                            <span class="dropdown-item-icon">üí¨</span>
                            <span>AI Coach</span>
                        </a>
                        <div class="dropdown-item locked">
                            <span class="dropdown-item-icon">üèÜ</span>
                            <span>Tournaments</span>
                            <span style="margin-left: auto; font-size: 12px;">üîí</span>
                        </div>
                        <div class="dropdown-item locked">
                            <span class="dropdown-item-icon">üìä</span>
                            <span>Competitive Insights</span>
                            <span style="margin-left: auto; font-size: 12px;">üîí</span>
                        </div>
                        <div class="dropdown-item locked">
                            <span class="dropdown-item-icon">üé§</span>
                            <span>Voice</span>
                            <span style="margin-left: auto; font-size: 12px;">üîí</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="/docs.html" class="dropdown-item">
                            <span class="dropdown-item-icon">üìö</span>
                            <span>Documentation</span>
                        </a>
                    </div>
                </div>
                <a href="/cih-coaching.html" class="nav-link">CIH Coaching</a>
                <a href="/nagc-dropmaps.html" class="nav-link">NAGC Drop Maps</a>
            </div>

            <div class="nav-right">
                <a href="/subscribe.html" class="nav-link">Pricing</a>
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">P</div>
                    <span class="user-name" id="userName">crl_coach</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Subscription Required Popup - Matching Purchase Success Style -->
    <div class="subscription-popup-overlay" id="subscriptionPopup">
        <div class="subscription-popup" id="subscriptionPopupContent">
            <button class="popup-close" onclick="hideSubscriptionPopup()">√ó</button>
            <div class="popup-content">
                <div class="subscription-popup-icon">
                    <div class="success-icon-circle"></div>
                </div>
                <h2 class="subscription-popup-title">Voice Interaction Required</h2>
                <p class="subscription-popup-message">
                    Voice Interaction requires the Voice Add-On subscription. Please purchase it to continue using voice coaching.
                </p>
                <div class="subscription-popup-buttons">
                    <button class="subscription-popup-button primary" onclick="window.location.href='/subscribe.html'">
                        Upgrade to Voice Add-On
                    </button>
                    <button class="subscription-popup-button secondary" onclick="hideSubscriptionPopup(); checkVoiceSubscription();">
                        Check Again
                    </button>
                </div>
                <div class="subscription-popup-retry" id="subscriptionPopupRetry">
                    Just purchased? <button onclick="retrySubscriptionCheck()">Click here to refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Selection Screen -->
    <div class="container">
        <div class="voice-selection-screen" id="voiceSelectionScreen">
            <h1 class="screen-title">Choose a voice</h1>
            
            <div class="voice-carousel">
                <button class="carousel-arrow left" id="prevArrow" onclick="changeVoice(-1)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                
                <div class="carousel-container" id="carouselContainer">
                    <!-- Voice slides will be populated by JavaScript -->
                </div>
                
                <button class="carousel-arrow right" id="nextArrow" onclick="changeVoice(1)">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <div class="pagination-dots" id="paginationDots">
                <!-- Dots will be populated by JavaScript -->
            </div>

            <button class="continue-button" id="continueButton" disabled onclick="continueToInteraction()">
                Continue
            </button>
        </div>

        <!-- Voice Interaction Screen -->
        <div class="voice-interaction-screen" id="voiceInteractionScreen">
            <button class="back-button" onclick="goBackToSelection()">
                ‚Üê Back
            </button>

            <div class="interaction-header">
                <h1 class="header-title">Voice Coach</h1>
                <p class="header-subtitle">Chat with your Fortnite AI coach in real time</p>
                <div class="usage-display" id="usageDisplay">
                    <span id="usageText">Loading usage...</span>
                </div>
            </div>

            <!-- Usage Banners -->
            <div class="usage-banner warning" id="usageWarningBanner">
                <div class="usage-banner-content">
                    <span class="usage-banner-text" id="usageWarningText"></span>
                    <a href="/subscribe.html" class="usage-banner-link">Upgrade ‚Üí</a>
                </div>
            </div>

            <div class="usage-banner error" id="usageErrorBanner">
                <div class="usage-banner-content">
                    <span class="usage-banner-text" id="usageErrorText"></span>
                    <a href="/subscribe.html" class="usage-banner-link">Upgrade ‚Üí</a>
                </div>
            </div>

            <!-- Main Interaction Zone -->
            <div class="interaction-zone">
                <div class="mic-button-container">
                    <div class="mic-ring" id="micRing"></div>
                    <button class="mic-button" id="micButton" onmousedown="startVoiceRecording()" onmouseup="stopVoiceRecording()" ontouchstart="startVoiceRecording()" ontouchend="stopVoiceRecording()">
                        <svg fill="currentColor" viewBox="0 0 24 24" id="micIcon">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        <div class="spinner" id="micSpinner" style="display: none;"></div>
                    </button>
                </div>

                <div class="waveform-container" id="waveformContainer" style="display: none;">
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                </div>

                <div class="status-text" id="statusText">Hold to talk</div>
            </div>

            <!-- Response Feed -->
            <div class="response-feed" id="responseFeed">
                <!-- Responses will be added here -->
            </div>
        </div>
    </div>

    <script>
        // Voice data
        const voices = [
            { id: 'vale', name: 'Vale', description: 'Bright and inquisitive', gradient: 'vale' },
            { id: 'alloy', name: 'Alloy', description: 'Clear and confident', gradient: 'alloy' },
            { id: 'echo', name: 'Echo', description: 'Deep and resonant', gradient: 'echo' },
            { id: 'fable', name: 'Fable', description: 'Warm and expressive', gradient: 'fable' },
            { id: 'onxy', name: 'Onyx', description: 'Strong and authoritative', gradient: 'onxy' },
            { id: 'nova', name: 'Nova', description: 'Energetic and upbeat', gradient: 'nova' },
            { id: 'shimmer', name: 'Shimmer', description: 'Soft and gentle', gradient: 'shimmer' },
            { id: 'charon', name: 'Charon', description: 'Mysterious and calm', gradient: 'charon' }
        ];

        // Voice Interaction State Machine
        const VOICE_STATE = {
            IDLE: 'idle',
            RECORDING: 'recording',
            UPLOADING: 'uploading',
            PROCESSING: 'processing',
            PLAYING: 'playing',
            LIMIT_REACHED: 'limit_reached'
        };

        let selectedVoice = null;
        let currentVoiceIndex = 0;
        let currentState = VOICE_STATE.IDLE;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;
        let recordingStartTime = null;
        let currentAudio = null;
        let voiceConversationHistory = []; // Track conversation for context
        let usageData = { remaining: 0, limit: 0, used: 0, tier: 'free' };
        let isProcessingVoice = false; // Prevent double-submission of voice recordings

        // Check if user has Voice Interaction subscription (with retry support)
        async function checkVoiceSubscription(retryCount = 0) {
            try {
                // Get user data from localStorage
                let userData = null;
                const pathgenUser = localStorage.getItem('pathgen_user');
                const discordUser = localStorage.getItem('discordUser');
                const firebaseUser = localStorage.getItem('firebaseUser');

                if (pathgenUser) {
                    try {
                        userData = JSON.parse(pathgenUser);
                    } catch (e) {
                        console.error('Error parsing pathgen_user:', e);
                    }
                } else if (discordUser) {
                    try {
                        userData = JSON.parse(discordUser);
                    } catch (e) {
                        console.error('Error parsing discordUser:', e);
                    }
                } else if (firebaseUser) {
                    try {
                        userData = JSON.parse(firebaseUser);
                    } catch (e) {
                        console.error('Error parsing firebaseUser:', e);
                    }
                }

                // Extract userId
                let userId = null;
                if (userData) {
                    if (userData.discordId) {
                        userId = userData.discordId;
                    } else if (userData.id) {
                        userId = userData.id;
                    } else if (userData.email) {
                        userId = userData.email;
                    }
                }

                if (!userId) {
                    console.error('No userId found for subscription check');
                    if (retryCount === 0) {
                        showSubscriptionPopup();
                    }
                    return false;
                }

                // Check subscription via API
                const response = await fetch('/api/voice/check-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId }),
                    // Add timeout to prevent hanging
                    signal: AbortSignal.timeout(10000) // 10 second timeout
                });

                if (!response.ok) {
                    console.error('Error checking subscription:', response.status);
                    // On API error, show popup if first attempt
                    if (retryCount === 0) {
                        showSubscriptionPopup();
                    }
                    return false;
                }

                const data = await response.json();

                if (data.hasAccess) {
                    console.log('[INFO] User has Voice Interaction subscription access');
                    // Hide popup if it's showing
                    hideSubscriptionPopup();
                    return true;
                } else {
                    console.log('[INFO] User does not have Voice Interaction subscription');
                    // Only show popup on first attempt (not on retries)
                    if (retryCount === 0) {
                        showSubscriptionPopup();
                    }
                    return false;
                }

            } catch (error) {
                console.error('Error checking voice subscription:', error);
                // On connection/network error, show popup if first attempt
                if (retryCount === 0) {
                    showSubscriptionPopup();
                }
                return false;
            }
        }

        // Show subscription required popup
        function showSubscriptionPopup() {
            const popup = document.getElementById('subscriptionPopup');
            const popupContent = document.getElementById('subscriptionPopupContent');
            if (popup && popupContent) {
                popup.classList.add('show');
                setTimeout(() => {
                    popupContent.classList.add('show');
                }, 10);
            }
        }

        // Hide subscription popup
        function hideSubscriptionPopup() {
            const popup = document.getElementById('subscriptionPopup');
            const popupContent = document.getElementById('subscriptionPopupContent');
            if (popup && popupContent) {
                popupContent.classList.remove('show');
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 200);
            }
        }

        // Retry subscription check (for after purchase)
        let retryAttempts = 0;
        const MAX_RETRIES = 5;
        
        async function retrySubscriptionCheck() {
            const retryButton = event?.target || document.querySelector('.subscription-popup-retry button');
            const retryText = document.querySelector('.subscription-popup-retry');
            
            if (retryButton) {
                retryButton.textContent = 'Checking...';
                retryButton.disabled = true;
            }

            // Wait a moment for webhook to process (longer wait on first attempt)
            const waitTime = retryAttempts === 0 ? 3000 : 2000;
            await new Promise(resolve => setTimeout(resolve, waitTime));

            retryAttempts++;
            
            const hasAccess = await checkVoiceSubscription(1); // Pass 1 to indicate retry
            if (hasAccess) {
                hideSubscriptionPopup();
                // Update user info and render voices
                updateUserInfo();
                renderVoices();
                
                // Also load usage data
                const interactionScreen = document.getElementById('voiceInteractionScreen');
                if (interactionScreen && interactionScreen.classList.contains('active')) {
                    loadUsageData();
                }
                
                // Show success message
                if (retryText) {
                    retryText.innerHTML = '<span style="color: #22c55e;">‚úì Subscription activated! Reloading...</span>';
                }
                
                // Reload page after a moment to ensure everything updates
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                if (retryAttempts >= MAX_RETRIES) {
                    if (retryButton) {
                        retryButton.textContent = 'Refresh Page';
                        retryButton.onclick = () => window.location.reload();
                    }
                    if (retryText) {
                        retryText.innerHTML = '<span style="color: #f5576c;">Still processing. Please refresh the page in a few seconds.</span>';
                    }
                } else {
                    if (retryButton) {
                        retryButton.textContent = `Try Again (${retryAttempts}/${MAX_RETRIES})`;
                        retryButton.disabled = false;
                    }
                    if (retryText) {
                        retryText.innerHTML = `Just purchased? <button onclick="retrySubscriptionCheck()">Try Again (${retryAttempts}/${MAX_RETRIES})</button>`;
                    }
                }
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            // TEMPORARILY LOCKED - Voice add-on is not available for purchase
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; max-width: 600px; margin: 0 auto;">
                        <div style="font-size: 64px; margin-bottom: 24px;">üîí</div>
                        <h1 style="color: #ffffff; font-size: 2rem; font-weight: 700; margin-bottom: 16px;">Temporarily Unavailable</h1>
                        <p style="color: #9ca3af; font-size: 1rem; line-height: 1.6; margin-bottom: 32px;">
                            Voice Interaction is currently unavailable for purchase. We're working on improvements and will make it available again soon.
                        </p>
                        <a href="/subscribe.html" style="display: inline-block; padding: 12px 24px; background: #8B5CF6; color: #ffffff; text-decoration: none; border-radius: 8px; font-weight: 600; transition: background 0.2s;">
                            View Other Plans ‚Üí
                        </a>
                    </div>
                `;
            }
            return;

            // Check authentication
            // DISABLED: Allow access without authentication
            // try {
            //     const auth = localStorage.getItem('pathgen_user') || localStorage.getItem('discordUser') || localStorage.getItem('firebaseUser');
            //     if (!auth) {
            //         window.location.replace('/login.html');
            //         return;
            //     }
            // } catch (_) {
            //     window.location.replace('/login.html');
            //     return;
            // }

            // Check subscription before allowing access
            const hasAccess = await checkVoiceSubscription();
            if (!hasAccess) {
                // Subscription check failed or user doesn't have access
                // Popup will be shown by checkVoiceSubscription
                return;
            }

            // Update user info in navbar
            updateUserInfo();

            renderVoices();
            
            // Load usage data when interaction screen is shown
            const interactionScreen = document.getElementById('voiceInteractionScreen');
            if (interactionScreen) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (interactionScreen.classList.contains('active')) {
                                loadUsageData();
                            }
                        }
                    });
                });
                observer.observe(interactionScreen, { attributes: true });
            }
        });

        function updateUserInfo() {
            try {
                // Priority: Check Discord user first (identify scope)
                const discordUserStr = localStorage.getItem('discordUser');
                const userAvatarEl = document.getElementById('userAvatar');
                const userNameEl = document.getElementById('userName');
                
                if (discordUserStr) {
                    const discordUser = JSON.parse(discordUserStr);
                    
                    // Use Discord username (from identify scope)
                    const userName = discordUser.username || 'User';
                    if (userNameEl) userNameEl.textContent = userName;
                    
                    // Use Discord avatar
                    if (userAvatarEl && discordUser.avatar && discordUser.id) {
                        // Construct Discord avatar URL
                        const avatarUrl = `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png?size=128`;
                        userAvatarEl.innerHTML = `<img src="${avatarUrl}" alt="${userName}" onerror="this.style.display='none'; this.parentElement.textContent='${userName.charAt(0).toUpperCase()}'; this.parentElement.style.background='linear-gradient(135deg, #3b82f6 0%, #a855f7 100%)';" />`;
                    } else if (userAvatarEl && discordUser.id) {
                        // Fallback to default Discord avatar
                        const avatarNum = discordUser.discriminator ? (parseInt(discordUser.discriminator) % 5) : (parseInt(discordUser.id) % 5);
                        const defaultAvatarUrl = `https://cdn.discordapp.com/embed/avatars/${avatarNum}.png`;
                        userAvatarEl.innerHTML = `<img src="${defaultAvatarUrl}" alt="${userName}" onerror="this.style.display='none'; this.parentElement.textContent='${userName.charAt(0).toUpperCase()}'; this.parentElement.style.background='linear-gradient(135deg, #3b82f6 0%, #a855f7 100%)';" />`;
                    } else if (userAvatarEl) {
                        // Final fallback: use initial
                        userAvatarEl.textContent = userName.charAt(0).toUpperCase();
                    }
                } else {
                    // Fallback to other user data sources
                    const userDataStr = localStorage.getItem('pathgen_user') || localStorage.getItem('firebaseUser');
                    if (userDataStr) {
                        const userData = JSON.parse(userDataStr);
                        const userName = userData.discordUsername || userData.googleUsername || userData.username || userData.displayName || userData.email?.split('@')[0] || 'User';
                        const userInitial = userName.charAt(0).toUpperCase();
                        
                        if (userAvatarEl) {
                            // Check if there's a Discord avatar, Google avatar, or generic avatar URL in userData
                            const avatarUrl = userData.discordAvatar || userData.googleAvatar || userData.avatar;
                            if (avatarUrl) {
                                userAvatarEl.innerHTML = `<img src="${avatarUrl}" alt="${userName}" onerror="this.style.display='none'; this.parentElement.textContent='${userInitial}'; this.parentElement.style.background='linear-gradient(135deg, #3b82f6 0%, #a855f7 100%)';" />`;
                            } else {
                                userAvatarEl.textContent = userInitial;
                            }
                        }
                        const displayName = userData.discordUsername || userData.googleUsername || userData.username || userData.displayName || userData.email?.split('@')[0] || 'User';
                        if (userNameEl) userNameEl.textContent = displayName;
                    }
                }
            } catch (e) {
                console.error('Error updating user info:', e);
            }
        }

        function renderVoices() {
            const carouselContainer = document.getElementById('carouselContainer');
            const paginationDots = document.getElementById('paginationDots');

            voices.forEach((voice, index) => {
                // Voice slide
                const voiceSlide = document.createElement('div');
                voiceSlide.className = 'voice-slide';
                voiceSlide.dataset.voiceId = voice.id;
                voiceSlide.dataset.index = index;
                if (index === 0) voiceSlide.classList.add('active');

                voiceSlide.innerHTML = `
                    <div class="voice-avatar ${voice.gradient}" onclick="selectVoice('${voice.id}')">
                        <div class="voice-avatar-inner"></div>
                    </div>
                    <div class="voice-name">${voice.name}</div>
                    <div class="voice-description">${voice.description}</div>
                `;

                carouselContainer.appendChild(voiceSlide);

                // Pagination dot
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (index === 0) dot.classList.add('active');
                dot.onclick = () => goToVoice(index);
                paginationDots.appendChild(dot);
            });

            updateArrowButtons();
        }

        function changeVoice(direction) {
            const newIndex = currentVoiceIndex + direction;
            if (newIndex >= 0 && newIndex < voices.length) {
                goToVoice(newIndex);
            }
        }

        function goToVoice(index) {
            if (index < 0 || index >= voices.length) return;

            currentVoiceIndex = index;
            
            // Update slides
            document.querySelectorAll('.voice-slide').forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });

            // Update dots
            document.querySelectorAll('.dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });

            // Auto-select the voice when navigating
            const voice = voices[index];
            selectVoice(voice.id);

            updateArrowButtons();
        }

        function selectVoice(voiceId) {
            selectedVoice = voiceId;
            
            // Update avatar selection
            document.querySelectorAll('.voice-avatar').forEach(avatar => {
                const slide = avatar.closest('.voice-slide');
                if (slide && slide.dataset.voiceId === voiceId) {
                    avatar.classList.add('selected');
                } else {
                    avatar.classList.remove('selected');
                }
            });

            document.getElementById('continueButton').disabled = false;
        }

        function updateArrowButtons() {
            const prevArrow = document.getElementById('prevArrow');
            const nextArrow = document.getElementById('nextArrow');
            
            prevArrow.disabled = currentVoiceIndex === 0;
            nextArrow.disabled = currentVoiceIndex === voices.length - 1;
        }

        function continueToInteraction() {
            if (!selectedVoice) {
                // Select current voice if none selected
                selectedVoice = voices[currentVoiceIndex].id;
            }

            localStorage.setItem('selectedVoice', selectedVoice);
            document.getElementById('voiceSelectionScreen').classList.add('hidden');
            document.getElementById('voiceInteractionScreen').classList.add('active');
            loadUsageData();
        }

        // Load and display usage data
        async function loadUsageData() {
            const usageText = document.getElementById('usageText');
            if (usageText) {
                usageText.textContent = 'Loading usage...';
            }

            try {
                // Get user data from localStorage
                let userData = null;
                const pathgenUser = localStorage.getItem('pathgen_user');
                const discordUser = localStorage.getItem('discordUser');
                const firebaseUser = localStorage.getItem('firebaseUser');

                if (pathgenUser) {
                    try {
                        userData = JSON.parse(pathgenUser);
                    } catch (e) {
                        console.error('Error parsing pathgen_user:', e);
                    }
                } else if (discordUser) {
                    try {
                        userData = JSON.parse(discordUser);
                    } catch (e) {
                        console.error('Error parsing discordUser:', e);
                    }
                } else if (firebaseUser) {
                    try {
                        userData = JSON.parse(firebaseUser);
                    } catch (e) {
                        console.error('Error parsing firebaseUser:', e);
                    }
                }

                // Extract userId and email - prioritize discordId, then id, then email
                let userId = null;
                let userEmail = null;
                if (userData) {
                    // Check pathgen_user structure first
                    if (userData.discordId) {
                        userId = userData.discordId;
                    } else if (userData.id) {
                        userId = userData.id;
                    } else if (userData.email) {
                        userId = userData.email;
                    }
                    // Always extract email if available for fallback lookup
                    if (userData.email) {
                        userEmail = userData.email;
                    }
                }

                if (!userId) {
                    console.error('No userId found in user data:', userData);
                    if (usageText) {
                        usageText.textContent = 'Unable to load usage. Please log in again.';
                    }
                    return;
                }

                console.log('[INFO] Loading usage for userId:', userId, 'email:', userEmail);

                const response = await fetch('/api/voice/usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, email: userEmail, durationSeconds: 0 })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Error loading usage:', errorData);
                    
                    if (response.status === 404) {
                        // User doesn't exist in Firestore yet - create them
                        console.log('[INFO] User not found in Firestore, attempting to create...');
                        try {
                            const createUserResponse = await fetch('/api/users/create', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: userId,
                                    email: userData?.email || '',
                                    username: userData?.username || userData?.discordUsername || userData?.name || '',
                                    displayName: userData?.displayName || userData?.name || ''
                                })
                            });

                            if (createUserResponse.ok) {
                                // Retry loading usage after creating user
                                setTimeout(() => loadUsageData(), 1000);
                                return;
                            }
                        } catch (createError) {
                            console.error('Error creating user:', createError);
                        }
                    }

                    if (usageText) {
                        usageText.textContent = 'Unable to load usage data.';
                    }
                    return;
                }

                const data = await response.json();
                usageData = data;
                updateUsageDisplay();
                checkUsageBanners();
                console.log('[SUCCESS] Usage data loaded:', data);

            } catch (error) {
                console.error('Error loading usage data:', error);
                const usageText = document.getElementById('usageText');
                if (usageText) {
                    usageText.textContent = 'Error loading usage. Please refresh.';
                }
            }
        }

        function updateUsageDisplay() {
            const usageDisplay = document.getElementById('usageDisplay');
            const usageText = document.getElementById('usageText');
            
            if (!usageDisplay || !usageText) return;

            if (usageData.tier === 'free') {
                const secondsUsed = usageData.used || 0;
                const secondsLimit = usageData.limit || 60;
                const interactionsLimit = usageData.interactionsLimit || 10;
                const interactionsRemaining = usageData.interactionsRemaining !== undefined ? usageData.interactionsRemaining : interactionsLimit;
                const interactionsUsed = interactionsLimit - interactionsRemaining;
                
                if (usageData.interactionsLimit !== undefined) {
                    usageText.textContent = `${interactionsUsed} / ${interactionsLimit} interactions, ${secondsUsed} / ${secondsLimit}s used this month`;
                } else {
                    usageText.textContent = `${secondsUsed} / ${secondsLimit} seconds used this month`;
                }
            } else if (usageData.tier === 'voice_addon') {
                const interactionsLimit = usageData.interactionsLimit || 550;
                const interactionsRemaining = usageData.interactionsRemaining !== undefined ? usageData.interactionsRemaining : interactionsLimit;
                const interactionsUsed = interactionsLimit - interactionsRemaining;
                const minutesUsed = Math.floor((usageData.used || 0) / 60);
                
                if (usageData.remaining === -1 || usageData.limit === -1) {
                    usageText.textContent = `${interactionsUsed} / ${interactionsLimit} interactions, ${minutesUsed}+ minutes used (unlimited)`;
                } else {
                    const minutesLimit = Math.floor((usageData.limit || 0) / 60);
                    usageText.textContent = `${interactionsUsed} / ${interactionsLimit} interactions, ${minutesUsed} / ${minutesLimit} minutes used`;
                }
            } else {
                usageText.textContent = 'Voice not available';
            }

            // Update display styling based on usage
            usageDisplay.classList.remove('warning', 'error');
            
            if (!usageData.allowed) {
                usageDisplay.classList.add('error');
            } else {
                const usagePercent = usageData.limit > 0 ? (usageData.used / usageData.limit) * 100 : 0;
                const interactionsPercent = usageData.interactionsLimit > 0 && usageData.interactionsRemaining !== undefined
                    ? ((usageData.interactionsLimit - usageData.interactionsRemaining) / usageData.interactionsLimit) * 100 : 0;
                
                const maxPercent = Math.max(usagePercent, interactionsPercent);
                
                if (maxPercent >= 100) {
                    usageDisplay.classList.add('error');
                } else if (maxPercent >= 80) {
                    usageDisplay.classList.add('warning');
                }
            }
        }

        function checkUsageBanners() {
            const warningBanner = document.getElementById('usageWarningBanner');
            const errorBanner = document.getElementById('usageErrorBanner');
            const warningText = document.getElementById('usageWarningText');
            const errorText = document.getElementById('usageErrorText');

            if (!usageData.allowed) {
                errorBanner.classList.add('active');
                warningBanner.classList.remove('active');
                errorText.textContent = usageData.reason || 'Voice limit reached';
                setState(VOICE_STATE.LIMIT_REACHED);
            } else {
                errorBanner.classList.remove('active');
                const usagePercent = usageData.limit > 0 ? (usageData.used / usageData.limit) * 100 : 0;
                
                if (usagePercent >= 80 && usagePercent < 100) {
                    warningBanner.classList.add('active');
                    warningText.textContent = `You're running low on voice time. ${Math.floor(usageData.remaining / 60)} minutes remaining.`;
                } else {
                    warningBanner.classList.remove('active');
                }
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('voiceSelectionScreen').classList.contains('hidden')) {
                return;
            }
            
            if (e.key === 'ArrowLeft') {
                changeVoice(-1);
            } else if (e.key === 'ArrowRight') {
                changeVoice(1);
            } else if (e.key === 'Enter' && !document.getElementById('continueButton').disabled) {
                continueToInteraction();
            }
        });

        function goBackToSelection() {
            if (currentState === VOICE_STATE.RECORDING) {
                stopVoiceRecording();
            }
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            setState(VOICE_STATE.IDLE);
            document.getElementById('voiceSelectionScreen').classList.remove('hidden');
            document.getElementById('voiceInteractionScreen').classList.remove('active');
        }

        // State Machine
        function setState(newState) {
            currentState = newState;
            const micButton = document.getElementById('micButton');
            const micIcon = document.getElementById('micIcon');
            const micSpinner = document.getElementById('micSpinner');
            const micRing = document.getElementById('micRing');
            const statusText = document.getElementById('statusText');
            const waveformContainer = document.getElementById('waveformContainer');

            // Reset all states
            micButton.classList.remove('recording', 'processing', 'playing', 'disabled');
            micRing.classList.remove('recording');
            statusText.classList.remove('recording', 'processing', 'playing');
            waveformContainer.style.display = 'none';
            micIcon.style.display = 'block';
            micSpinner.style.display = 'none';

            switch (newState) {
                case VOICE_STATE.IDLE:
                    statusText.textContent = 'Hold to talk';
                    micButton.disabled = false;
                    break;
                case VOICE_STATE.RECORDING:
                    micButton.classList.add('recording');
                    micRing.classList.add('recording');
                    statusText.textContent = 'Listening...';
                    statusText.classList.add('recording');
                    waveformContainer.style.display = 'flex';
                    updateWaveform(true);
                    break;
                case VOICE_STATE.UPLOADING:
                case VOICE_STATE.PROCESSING:
                    micButton.classList.add('processing');
                    statusText.textContent = 'Processing...';
                    statusText.classList.add('processing');
                    micIcon.style.display = 'none';
                    micSpinner.style.display = 'block';
                    updateWaveform(false);
                    break;
                case VOICE_STATE.PLAYING:
                    micButton.classList.add('playing');
                    statusText.textContent = 'Playing response...';
                    statusText.classList.add('playing');
                    waveformContainer.style.display = 'flex';
                    updateWaveform(true);
                    break;
                case VOICE_STATE.LIMIT_REACHED:
                    micButton.classList.add('disabled');
                    micButton.disabled = true;
                    statusText.textContent = 'Voice limit reached';
                    break;
            }
        }

        // Start voice recording
        async function startVoiceRecording() {
            if (currentState === VOICE_STATE.LIMIT_REACHED || currentState === VOICE_STATE.PROCESSING || currentState === VOICE_STATE.UPLOADING) {
                return;
            }

            // Check usage before recording
            try {
                const userDataStr = localStorage.getItem('pathgen_user') || localStorage.getItem('discordUser') || localStorage.getItem('firebaseUser');
                const userData = userDataStr ? JSON.parse(userDataStr) : null;
                const userId = userData?.id || userData?.email || userData?.discordId || 'anonymous';
                const userEmail = userData?.email || null;

                const usageCheck = await fetch('/api/voice/usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, email: userEmail, durationSeconds: 10 }) // Estimate 10 seconds
                });

                if (usageCheck.ok) {
                    const usage = await usageCheck.json();
                    if (!usage.allowed) {
                        usageData = usage;
                        updateUsageDisplay();
                        checkUsageBanners();
                        setState(VOICE_STATE.LIMIT_REACHED);
                        return;
                    }
                    usageData = usage;
                    updateUsageDisplay();
                }
            } catch (error) {
                console.error('Error checking usage:', error);
            }

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    audioStream.getTracks().forEach(track => track.stop());
                };

                recordingStartTime = Date.now();
                mediaRecorder.start();
                setState(VOICE_STATE.RECORDING);
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Microphone access denied. Please enable microphone permissions.');
                setState(VOICE_STATE.IDLE);
            }
        }

        // Stop voice recording and process
        async function stopVoiceRecording() {
            if (currentState !== VOICE_STATE.RECORDING || !mediaRecorder || mediaRecorder.state === 'inactive') {
                console.log('[VOICE] Stop ignored - not recording or already stopped');
                return;
            }

            if (isProcessingVoice) {
                console.log('[VOICE] Already processing, ignoring duplicate stop');
                return;
            }

            console.log('[VOICE] Stopping recording...');
            isProcessingVoice = true;

            try {
                mediaRecorder.stop();
                const durationSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                setState(VOICE_STATE.UPLOADING);

                // Wait for recording to finish
                await new Promise(resolve => {
                    mediaRecorder.onstop = () => {
                        audioStream.getTracks().forEach(track => track.stop());
                        resolve();
                    };
                });

                // Create audio blob
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                // Send to backend
                await processVoiceAudio(audioBlob, durationSeconds);
            } catch (error) {
                console.error('[VOICE] Error in stopVoiceRecording:', error);
                setState(VOICE_STATE.IDLE);
                isProcessingVoice = false;
            }
        }

        // Process voice audio with backend
        async function processVoiceAudio(audioBlob, durationSeconds) {
            console.log('[VOICE] Processing audio blob, size:', audioBlob.size);
            
            try {
                const userDataStr = localStorage.getItem('pathgen_user') || localStorage.getItem('discordUser') || localStorage.getItem('firebaseUser');
                const userData = userDataStr ? JSON.parse(userDataStr) : null;
                const userId = userData?.id || userData?.email || userData?.discordId || 'anonymous';
                const userEmail = userData?.email || null;

                setState(VOICE_STATE.PROCESSING);

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('userId', userId);
                if (userEmail) {
                    formData.append('email', userEmail);
                }
                formData.append('durationSeconds', durationSeconds.toString());
                
                // Send conversation history for context
                if (voiceConversationHistory.length > 0) {
                    formData.append('conversationHistory', JSON.stringify(voiceConversationHistory.slice(-6))); // Last 6 messages
                }

                // Try API first, fallback to browser speech recognition
                let data;
                try {
                    const response = await fetch('/api/voice/coach', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (errorData.limitExceeded) {
                            usageData = errorData;
                            updateUsageDisplay();
                            checkUsageBanners();
                            setState(VOICE_STATE.LIMIT_REACHED);
                            return;
                        }
                        
                        // If Whisper model not available, use browser recognition + text chat API
                        if (errorData.message && errorData.message.includes('whisper')) {
                            console.log('[VOICE] Falling back to browser speech recognition + text chat');
                            data = await processWithBrowserSpeech();
                        } else {
                            throw new Error(errorData.error || 'Failed to process voice');
                        }
                    } else {
                        data = await response.json();
                    }
                } catch (apiError) {
                    console.error('[VOICE] API error, using fallback:', apiError);
                    data = await processWithBrowserSpeech();
                }

                // Update usage
                if (data.usage) {
                    usageData = data.usage;
                    updateUsageDisplay();
                    checkUsageBanners();
                }

                // Add to conversation history
                voiceConversationHistory.push(
                    { role: 'user', content: data.transcript },
                    { role: 'assistant', content: data.responseText }
                );
                
                // Add response to feed
                addResponseToFeed(data.transcript, data.responseText, data.responseAudio, data.metadata);

                // Play response audio
                if (data.responseAudio) {
                    playResponseAudio(data.responseAudio);
                } else if (data.metadata && data.metadata.fallback) {
                    // Use browser TTS for fallback
                    speakText(data.responseText);
                } else {
                    setState(VOICE_STATE.IDLE);
                }

            } catch (error) {
                console.error('Error processing voice:', error);
                alert('Failed to process voice. Please try again.');
                setState(VOICE_STATE.IDLE);
            }
        }

        // Fallback: Process with browser speech recognition + text chat API
        async function processWithBrowserSpeech() {
            console.log('[FALLBACK] Using simple text-to-speech fallback');
            
            // For now, just show an error message since browser speech recognition isn't set up
            throw new Error('Voice recognition requires OpenAI Whisper access. Please contact support to enable Whisper API on your OpenAI account, or use the text chat instead.');
        }

        // Add response to feed
        function addResponseToFeed(transcript, responseText, responseAudio, metadata) {
            const feed = document.getElementById('responseFeed');
            if (!feed) return;

            const category = metadata?.category || 'strategy';
            const categoryNames = {
                aim: 'Aim Advice',
                movement: 'Movement Tip',
                rotation: 'Storm Rotation',
                loadout: 'Loadout Suggestion',
                strategy: 'Strategy Tip',
                boxfighting: 'Box Fighting',
                endgame: 'End Game'
            };

            const item = document.createElement('div');
            item.className = 'response-item';
            item.innerHTML = `
                <div class="response-header">
                    <span class="response-title">${categoryNames[category] || 'Coaching Tip'}</span>
                    <span class="response-category">${category}</span>
                </div>
                <div class="response-transcript">"${transcript}"</div>
                <div class="response-text">${responseText}</div>
                ${responseAudio ? `
                <div class="response-actions">
                    <button class="play-button" onclick="playResponseFromFeed('${responseAudio}', this)">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <span>Replay</span>
                    </button>
                </div>
                ` : ''}
            `;

            feed.insertBefore(item, feed.firstChild);
        }

        // Play response audio
        function playResponseAudio(audioBase64) {
            try {
                const audioData = atob(audioBase64);
                const audioArray = new Uint8Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    audioArray[i] = audioData.charCodeAt(i);
                }

                const audioBlob = new Blob([audioArray], { type: 'audio/mp3' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                currentAudio = new Audio(audioUrl);
                setState(VOICE_STATE.PLAYING);

                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    setState(VOICE_STATE.IDLE);
                    currentAudio = null;
                };

                currentAudio.onerror = () => {
                    URL.revokeObjectURL(audioUrl);
                    setState(VOICE_STATE.IDLE);
                    currentAudio = null;
                };

                currentAudio.play();
            } catch (error) {
                console.error('Error playing audio:', error);
                setState(VOICE_STATE.IDLE);
            }
        }

        // Play response from feed
        function playResponseFromFeed(audioBase64, button) {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio = null;
                setState(VOICE_STATE.IDLE);
                return;
            }
            playResponseAudio(audioBase64);
        }

        function updateWaveform(animate) {
            const bars = document.querySelectorAll('.waveform-bar');
            bars.forEach(bar => {
                if (animate) {
                    bar.classList.add('animate');
                } else {
                    bar.classList.remove('animate');
                }
            });
        }

        // Subtle parallax on preview cards (from index.html)
        document.addEventListener('mousemove', (e) => {
            if (window.innerWidth < 968) return;

            const { clientX, clientY } = e;
            const { innerWidth, innerHeight } = window;

            const xPercent = (clientX / innerWidth - 0.5) * 15;
            const yPercent = (clientY / innerHeight - 0.5) * 15;

            const left = document.querySelector('.preview-left');
            const right = document.querySelector('.preview-right');

            if (left) {
                left.style.transform = `
                    translateX(${xPercent}px) 
                    translateY(${yPercent}px)
                    rotate(-8deg) 
                    perspective(1000px) 
                    rotateY(8deg)
                `;
            }

            if (right) {
                right.style.transform = `
                    translateX(${-xPercent}px) 
                    translateY(${-yPercent}px)
                    rotate(8deg) 
                    perspective(1000px) 
                    rotateY(-8deg)
                `;
            }
        });
    </script>
</body>
</html>

