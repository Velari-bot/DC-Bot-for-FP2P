// PathGen Backend â€” Fortnite AI Coach
// Firestore Security Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.admin == true;
    }
    
    // Helper function to check if user is banned
    function isNotBanned(uid) {
      let abuse = get(/databases/$(database)/documents/abuse/$(uid));
      return !abuse.exists || 
             !('bannedUntil' in abuse.data()) ||
             abuse.data().bannedUntil == null ||
             timestamp.date(abuse.data().bannedUntil) < request.time;
    }

    // /users/{uid}
    match /users/{uid} {
      // TEMPORARY: Allow all reads for debugging
      // TODO: Re-enable authentication check after fixing Discord OAuth
      allow read: if true;
      
      allow create: if true;
      
      allow update: if true &&
                     // Users CANNOT update subscription/payment data
                     !('stripeCustomerId' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('stripeSubscriptionId' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('isPremium' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('plan' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('addons' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('subscriptionStatus' in request.resource.data.diff(resource.data).affectedKeys()) &&
                     !('activePlanId' in request.resource.data.diff(resource.data).affectedKeys());
      
      allow delete: if isAdmin();
    }

    // /subscriptions/{uid}
    match /subscriptions/{uid} {
      allow read: if true; // TEMPORARY: Allow all reads for debugging
      // CRITICAL: Only backend (Firebase Admin) can write subscription data
      // This prevents users from granting themselves premium access
      allow create, update, delete: if false;
    }

    // /usage/{uid}
    match /usage/{uid} {
      allow read: if true; // TEMPORARY: Allow all reads for debugging
      // CRITICAL: Only backend can modify usage data
      // This prevents users from resetting their own limits
      allow create, update, delete: if false;
    }

    // /conversations/{uid}/{conversationId}
    match /conversations/{uid}/conversations/{conversationId} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isAuthenticated() && isOwner(uid) && isNotBanned(uid);
      allow update: if isAuthenticated() && isOwner(uid) && isNotBanned(uid);
      allow delete: if isOwner(uid) || isAdmin();
    }

    // /messages/{uid}/{conversationId}/{messageId}
    match /messages/{uid}/{conversationId}/{messageId} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isAuthenticated() && isOwner(uid) && isNotBanned(uid);
      allow update: if false; // Messages are immutable
      allow delete: if isOwner(uid) || isAdmin();
    }

    // /config/global
    match /config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // /webhooks/stripe/{eventId}
    match /webhooks/stripe/{eventId} {
      allow read, write: if false; // Only backend functions can access
    }

    // /abuse/{uid}
    match /abuse/{uid} {
      allow read: if isAdmin();
      allow write: if false; // Only backend functions can write
    }

    // /admin/*
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }

    // /anonymous_messages/{messageId}
    // Allow anonymous users to write tracking data (for analytics)
    match /anonymous_messages/{messageId} {
      allow create: if true; // Allow anonymous writes for analytics
      allow read: if isAdmin(); // Only admins can read
      allow update, delete: if false; // Immutable after creation
    }
  }
}
